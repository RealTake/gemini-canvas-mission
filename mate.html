<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>우테코 회의 메이트 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .woowa-bg { background-color: #2ac1bc; }
        .woowa-text { color: #2ac1bc; }
        .recording-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: .7; transform: scale(1.05); }
        }
        .hidden { display: none; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chat-bubble-ai { border-radius: 20px 20px 20px 4px; }
        .chat-bubble-user { border-radius: 20px 20px 4px 20px; }

        /* Audio Player Styling */
        audio { filter: sepia(20%) saturate(70%) hue-rotate(130deg); }
        audio::-webkit-media-controls-panel {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">

<header class="woowa-bg text-white p-4 shadow-md sticky top-0 z-40">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold flex items-center gap-2">
            <i data-lucide="sparkles"></i> 우테코 회의 메이트 Pro
        </h1>
        <div class="flex items-center gap-2">
            <span class="text-[10px] bg-white/20 px-2 py-1 rounded-full border border-white/30 font-bold">음성 레코딩 & AI 분석</span>
        </div>
    </div>
</header>

<main class="max-w-4xl mx-auto p-4 md:p-8">
    <section class="bg-white rounded-2xl shadow-sm p-8 mb-8 text-center border border-gray-100 transition-all">
        <div id="status-container" class="mb-6">
            <div id="visualizer" class="h-12 flex items-center justify-center gap-1 mb-4 hidden">
                <div class="w-1 bg-teal-400 h-4 rounded-full animate-bounce"></div>
                <div class="w-1 bg-teal-500 h-8 rounded-full animate-bounce [animation-delay:0.2s]"></div>
                <div class="w-1 bg-teal-600 h-10 rounded-full animate-bounce [animation-delay:0.4s]"></div>
                <div class="w-1 bg-teal-500 h-8 rounded-full animate-bounce [animation-delay:0.6s]"></div>
                <div class="w-1 bg-teal-400 h-4 rounded-full animate-bounce [animation-delay:0.8s]"></div>
            </div>
            <p id="status-text" class="text-gray-500 font-medium text-lg">새로운 회의를 기록하고 음성 원본을 보관하세요</p>
            <div id="timer" class="text-5xl font-black mt-3 hidden text-teal-600 font-mono tracking-tight">00:00</div>
        </div>

        <div class="flex justify-center gap-4 items-center">
            <button id="start-btn" class="woowa-bg text-white px-10 py-4 rounded-full font-bold text-lg flex items-center gap-2 hover:bg-teal-600 transition-all shadow-xl active:scale-95">
                <i data-lucide="mic"></i> 회의 시작하기
            </button>
            <button id="stop-btn" class="bg-red-500 text-white px-10 py-4 rounded-full font-bold text-lg flex items-center gap-2 hover:bg-red-600 transition-all shadow-xl active:scale-95 hidden">
                <i data-lucide="circle-stop" class="fill-current"></i> 기록 완료 및 분석
            </button>
        </div>

        <div id="loading-spinner" class="mt-6 hidden">
            <div class="flex flex-col items-center gap-3">
                <div class="relative">
                    <div class="animate-spin rounded-full h-12 w-12 border-4 border-teal-100 border-t-teal-500"></div>
                    <i data-lucide="cpu" class="w-5 h-5 absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-teal-500"></i>
                </div>
                <p class="text-teal-600 font-bold">음성 저장 완료! AI가 대화를 분석 중입니다...</p>
            </div>
        </div>
    </section>

    <section>
        <div class="flex justify-between items-center mb-6 px-2">
            <h2 class="text-xl font-extrabold flex items-center gap-2">
                <i data-lucide="layers" class="w-6 h-6 text-teal-600"></i> 아카이브
            </h2>
            <button id="clear-all" class="text-sm text-gray-400 hover:text-red-500 flex items-center gap-1 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i> 기록 비우기
            </button>
        </div>

        <div id="meeting-list" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-1">
            <div id="empty-state" class="col-span-full text-center py-24 bg-white rounded-3xl border-2 border-dashed border-gray-100">
                <div class="bg-gray-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="message-square-dashed" class="w-10 h-10 text-gray-300"></i>
                </div>
                <p class="text-gray-400 font-medium">아직 기록된 회의가 없습니다.<br>첫 회의를 시작해 보세요!</p>
            </div>
        </div>
    </section>
</main>

<div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white w-full max-w-3xl rounded-[2rem] max-h-[92vh] flex flex-col shadow-2xl overflow-hidden border border-white/20">
        <div class="p-6 border-b border-gray-100 flex justify-between items-start bg-white">
            <div class="pr-8">
                <span id="modal-date" class="text-[10px] font-bold text-teal-600 bg-teal-50 px-2 py-1 rounded mb-2 inline-block"></span>
                <h3 id="modal-title" class="text-2xl font-black text-gray-900 leading-tight"></h3>
            </div>
            <button id="close-modal" class="p-2 hover:bg-gray-100 rounded-2xl transition-all">
                <i data-lucide="x" class="w-6 h-6 text-gray-400"></i>
            </button>
        </div>

        <div id="modal-content-wrapper" class="flex-1 overflow-y-auto p-6 space-y-10 bg-slate-50/50">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

<script>
    const apiKey = "";
    let mediaRecorder;
    let audioChunks = [];
    let startTime;
    let timerInterval;
    let meetings = [];
    let recordingMimeType = "";

    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusText = document.getElementById('status-text');
    const timerText = document.getElementById('timer');
    const loadingSpinner = document.getElementById('loading-spinner');
    const visualizer = document.getElementById('visualizer');
    const meetingList = document.getElementById('meeting-list');
    const emptyState = document.getElementById('empty-state');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalContentWrapper = document.getElementById('modal-content-wrapper');
    const closeModal = document.getElementById('close-modal');

    lucide.createIcons();

    function getSupportedMimeType() {
        const types = ['audio/webm', 'audio/mp4', 'audio/ogg', 'audio/wav'];
        for (const type of types) {
            if (MediaRecorder.isTypeSupported(type)) return type;
        }
        return "";
    }

    function updateTimer() {
        const now = Date.now();
        const diff = now - startTime;
        const mins = Math.floor(diff / 60000).toString().padStart(2, '0');
        const secs = Math.floor((diff % 60000) / 1000).toString().padStart(2, '0');
        timerText.textContent = `${mins}:${secs}`;
    }

    // 타임라인 클릭 시 오디오 이동 함수
    window.seekToTime = (timeStr) => {
        const audio = modalContentWrapper.querySelector('audio');
        if (!audio) return;

        const parts = timeStr.split(':').map(Number);
        let seconds = 0;
        if (parts.length === 2) {
            seconds = parts[0] * 60 + parts[1];
        } else if (parts.length === 3) {
            seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
        }

        audio.currentTime = seconds;
        audio.play().catch(e => console.error("Playback failed", e));
    };

    // TODO 토글 함수 추가
    window.toggleTodo = (meetingId, todoIndex, element) => {
        const meeting = meetings.find(m => m.id === meetingId);
        if (!meeting) return;

        // 상태 토글
        meeting.todos[todoIndex].done = !meeting.todos[todoIndex].done;
        const isDone = meeting.todos[todoIndex].done;

        // DOM 직접 업데이트 (부드러운 전환을 위해)
        const checkInner = element.querySelector('.check-inner');
        const textSpan = element.querySelector('.todo-text');

        if (isDone) {
            checkInner.classList.remove('opacity-0', 'group-hover/todo:opacity-40');
            checkInner.classList.add('opacity-100');
            element.classList.replace('bg-orange-50/30', 'bg-orange-50');
            textSpan.classList.add('line-through', 'text-gray-400');
            textSpan.classList.remove('text-gray-800');
        } else {
            checkInner.classList.add('opacity-0', 'group-hover/todo:opacity-40');
            checkInner.classList.remove('opacity-100');
            element.classList.replace('bg-orange-50', 'bg-orange-50/30');
            textSpan.classList.remove('line-through', 'text-gray-400');
            textSpan.classList.add('text-gray-800');
        }
    };

    startBtn.addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            recordingMimeType = getSupportedMimeType();

            mediaRecorder = new MediaRecorder(stream, { mimeType: recordingMimeType });
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: recordingMimeType });
                const audioUrl = URL.createObjectURL(audioBlob);
                await processAudioWithGemini(audioBlob, audioUrl);
            };

            mediaRecorder.start();
            startTime = Date.now();
            timerText.textContent = "00:00";
            timerInterval = setInterval(updateTimer, 1000);

            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            timerText.classList.remove('hidden');
            visualizer.classList.remove('hidden');
            statusText.textContent = "회의 내용을 녹음하고 있습니다...";
            statusText.classList.add('recording-pulse', 'text-teal-600');
        } catch (err) {
            alert("마이크 접근 권한이 필요합니다.");
        }
    });

    stopBtn.addEventListener('click', () => {
        mediaRecorder.stop();
        clearInterval(timerInterval);
        stopBtn.classList.add('hidden');
        loadingSpinner.classList.remove('hidden');
        visualizer.classList.add('hidden');
        statusText.textContent = "녹음 파일 저장 완료. 분석을 시작합니다.";
        statusText.classList.remove('recording-pulse', 'text-teal-600');
        timerText.classList.add('hidden');
        mediaRecorder.stream.getTracks().forEach(track => track.stop());
    });

    async function processAudioWithGemini(audioBlob, audioUrl) {
        const base64Audio = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(audioBlob);
        });

        const systemPrompt = `
                당신은 우아한테크코스 회의 전문가 AI입니다.
                전달받은 음성을 듣고 다음 JSON 구조로 응답하세요:
                {
                    "title": "회의 핵심 주제 제목",
                    "summary": "회의 전체의 흐름과 결론 요약",
                    "dialogue": [
                        {
                            "time": "MM:SS",
                            "speaker": "화자 이름/역할",
                            "role": "moderator | participant",
                            "message": "발화 내용"
                        }
                    ],
                    "todos": ["할 일 내용"]
                }
            `;

        let retries = 0;
        const maxRetries = 5;

        async function callApi() {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { inlineData: { mimeType: recordingMimeType || "audio/webm", data: base64Audio } }
                            ]
                        }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const resultText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                const result = JSON.parse(resultText);

                saveMeeting({
                    ...result,
                    audioUrl: audioUrl,
                    mimeType: recordingMimeType,
                    id: Date.now(),
                    date: new Date().toLocaleString('ko-KR', {
                        year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    })
                });
            } catch (e) {
                if (retries < maxRetries) {
                    retries++;
                    setTimeout(callApi, Math.pow(2, retries) * 1000);
                } else {
                    alert("AI 분석 중 네트워크 오류가 발생했습니다.");
                    resetUI();
                }
            }
        }
        await callApi();
    }

    function saveMeeting(meeting) {
        // TODO 항목을 상태를 가질 수 있는 객체로 변환하여 저장
        if (meeting.todos && Array.isArray(meeting.todos)) {
            meeting.todos = meeting.todos.map(todo =>
                typeof todo === 'string' ? { text: todo, done: false } : todo
            );
        }

        meetings.unshift(meeting);
        renderMeetings();
        resetUI();
    }

    function resetUI() {
        loadingSpinner.classList.add('hidden');
        startBtn.classList.remove('hidden');
        statusText.textContent = "회의를 시작하려면 아래 버튼을 눌러주세요";
        statusText.classList.remove('text-teal-600');
        timerText.textContent = "00:00";
    }

    function renderMeetings() {
        if (meetings.length === 0) {
            emptyState.classList.remove('hidden');
            meetingList.innerHTML = '';
            meetingList.appendChild(emptyState);
            return;
        }

        emptyState.classList.add('hidden');
        meetingList.innerHTML = meetings.map(m => `
                <div class="bg-white p-6 rounded-[1.5rem] border border-gray-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group" onclick="openMeetingDetail(${m.id})">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-xl text-gray-800 group-hover:text-teal-600 transition-colors mb-1">${m.title}</h3>
                            <p class="text-xs text-gray-400 font-medium">${m.date}</p>
                        </div>
                        <div class="bg-teal-50 p-2 rounded-xl flex items-center gap-2">
                            <i data-lucide="mic-2" class="w-4 h-4 text-teal-500"></i>
                            <span class="text-[10px] text-teal-600 font-bold">음성보관됨</span>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 line-clamp-2 mb-6 leading-relaxed">"${m.summary}"</p>
                    <div class="flex items-center gap-4 pt-4 border-t border-gray-50">
                        <div class="flex items-center gap-1.5 text-xs font-bold text-gray-400">
                            <i data-lucide="users" class="w-3.5 h-3.5"></i> 대화 ${m.dialogue.length}건
                        </div>
                        <div class="flex items-center gap-1.5 text-xs font-bold text-orange-400">
                            <i data-lucide="check-circle-2" class="w-3.5 h-3.5"></i> 할 일 ${m.todos.length}건
                        </div>
                    </div>
                </div>
            `).join('');
        lucide.createIcons();
    }

    window.openMeetingDetail = (id) => {
        const meeting = meetings.find(m => m.id === id);
        if (!meeting) return;

        document.getElementById('modal-date').textContent = meeting.date;
        document.getElementById('modal-title').textContent = meeting.title;

        modalContentWrapper.innerHTML = `
                <div class="bg-white p-6 rounded-[2rem] border border-teal-100 shadow-sm flex flex-col sm:flex-row items-center gap-4">
                    <div class="bg-teal-500 text-white p-3 rounded-2xl">
                        <i data-lucide="headphones" class="w-6 h-6"></i>
                    </div>
                    <div class="flex-1 w-full">
                        <h4 class="text-xs font-black text-teal-600 uppercase mb-2">회의 원본 음성 다시듣기</h4>
                        <audio controls class="w-full h-11 rounded-lg">
                            <source src="${meeting.audioUrl}" type="${meeting.mimeType || 'audio/webm'}">
                            브라우저가 오디오 재생을 지원하지 않습니다.
                        </audio>
                        <p class="text-[10px] text-gray-400 mt-2 italic">* 대화 내용을 클릭하면 해당 시점으로 이동합니다.</p>
                    </div>
                </div>

                <div class="relative">
                    <div class="absolute -top-3 left-6 bg-teal-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow-sm z-10">AI 요약</div>
                    <div class="bg-white p-8 rounded-[2rem] border border-teal-100 shadow-sm">
                        <p class="text-gray-700 leading-relaxed font-semibold text-lg italic">"${meeting.summary}"</p>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-sm font-black text-slate-400 flex items-center gap-2 px-2 uppercase tracking-widest">
                        <i data-lucide="check-square" class="w-4 h-4 text-orange-500"></i> TODO 리스트
                    </h4>
                    <div class="grid gap-3">
                        ${meeting.todos.map((todo, idx) => {
            const isDone = todo.done;
            const text = todo.text || todo; // 이전 데이터 호환성
            return `
                                <div onclick="toggleTodo(${meeting.id}, ${idx}, this)" class="cursor-pointer flex items-center gap-4 p-4 rounded-2xl border border-orange-100/50 group/todo transition-colors ${isDone ? 'bg-orange-50' : 'bg-orange-50/30 hover:bg-orange-50'}">
                                    <div class="w-6 h-6 rounded-lg border-2 border-orange-200 flex items-center justify-center bg-white shrink-0">
                                        <div class="check-inner w-2 h-2 rounded-sm bg-orange-400 transition-opacity ${isDone ? 'opacity-100' : 'opacity-0 group-hover/todo:opacity-40'}"></div>
                                    </div>
                                    <span class="todo-text text-sm font-bold transition-all ${isDone ? 'line-through text-gray-400' : 'text-gray-800'}">${text}</span>
                                </div>
                            `;
        }).join('') || '<p class="text-sm text-gray-400 italic px-2">확정된 할 일이 없습니다.</p>'}
                    </div>
                </div>

                <div class="space-y-6">
                    <div class="flex justify-between items-center px-2">
                        <h4 class="text-sm font-black text-slate-400 flex items-center gap-2 uppercase tracking-widest">
                            <i data-lucide="messages-square" class="w-4 h-4 text-teal-500"></i> 대화 기록
                        </h4>
                        <div class="relative w-48">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-3.5 h-3.5 text-gray-400"></i>
                            <input type="text" id="dialogue-search" placeholder="기록 검색..."
                                class="w-full pl-9 pr-4 py-1.5 bg-white border border-gray-200 rounded-full text-xs focus:outline-none focus:ring-2 focus:ring-teal-500/20">
                        </div>
                    </div>

                    <div id="dialogue-list-container" class="space-y-8 px-2"></div>
                </div>
            `;

        const updateDialogueList = (query = '') => {
            const container = document.getElementById('dialogue-list-container');
            const filtered = meeting.dialogue.filter(item =>
                item.message.toLowerCase().includes(query.toLowerCase()) ||
                item.speaker.toLowerCase().includes(query.toLowerCase())
            );

            container.innerHTML = filtered.map((item, idx) => {
                const isOdd = idx % 2 === 0;
                return `
                        <div class="flex flex-col ${isOdd ? 'items-start' : 'items-end'} group">
                            <div class="flex items-center gap-2 mb-2 px-2">
                                <span class="text-[10px] font-black text-gray-300 font-mono">${item.time}</span>
                                <span class="text-xs font-bold text-gray-600">${item.speaker}</span>
                                ${item.role === 'moderator' ? '<span class="text-[9px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded border border-indigo-100 font-bold">진행자</span>' : ''}
                            </div>
                            <div onclick="seekToTime('${item.time}')"
                                class="max-w-[85%] cursor-pointer ${isOdd ? 'bg-white chat-bubble-ai border-slate-100 hover:border-teal-200' : 'bg-teal-500 text-white chat-bubble-user border-teal-400 hover:bg-teal-600'}
                                p-4 shadow-sm border text-sm leading-relaxed transition-all group-hover:shadow-md relative overflow-hidden">
                                ${highlightText(item.message, query)}
                                <div class="absolute inset-0 bg-black/0 hover:bg-black/5 pointer-events-none transition-colors"></div>
                            </div>
                        </div>
                    `;
            }).join('') || '<p class="text-center py-10 text-gray-400 text-sm italic">검색 결과가 없습니다.</p>';
        };

        const searchInput = document.getElementById('dialogue-search');
        searchInput.addEventListener('input', (e) => updateDialogueList(e.target.value));

        updateDialogueList();
        modalOverlay.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        lucide.createIcons();

        const audio = modalContentWrapper.querySelector('audio');
        if(audio) audio.load();
    };

    function highlightText(text, query) {
        if (!query) return text;
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark class="bg-yellow-200 text-gray-900 px-0.5 rounded-sm">$1</mark>');
    }

    closeModal.addEventListener('click', () => {
        modalOverlay.classList.add('hidden');
        document.body.style.overflow = 'auto';
        const audio = modalContentWrapper.querySelector('audio');
        if (audio) audio.pause();
    });

    modalOverlay.addEventListener('click', (e) => {
        if (e.target === modalOverlay) {
            modalOverlay.classList.add('hidden');
            document.body.style.overflow = 'auto';
            const audio = modalContentWrapper.querySelector('audio');
            if (audio) audio.pause();
        }
    });

    document.getElementById('clear-all').addEventListener('click', () => {
        if (confirm('모든 기록을 삭제할까요? 저장된 음성 파일도 함께 사라집니다.')) {
            meetings.forEach(m => URL.revokeObjectURL(m.audioUrl));
            meetings = [];
            renderMeetings();
        }
    });

    renderMeetings();
</script>
</body>
</html>